{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Geometra application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user.",
          "format": "uuid"
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "Display name of the user."
        }
      },
      "required": [
        "id",
        "email",
        "name"
      ]
    },
    "GeogebraApplet": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GeogebraApplet",
      "type": "object",
      "description": "Represents a Geogebra applet used in the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Geogebra applet."
        },
        "title": {
          "type": "string",
          "description": "Title of the Geogebra applet."
        },
        "description": {
          "type": "string",
          "description": "Description of the Geogebra applet."
        },
        "geogebraId": {
          "type": "string",
          "description": "The unique id assigned by Geogebra for the applet.",
          "format": "string"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who created the applet. (Relationship: User 1:N GeogebraApplet)"
        }
      },
      "required": [
        "id",
        "title",
        "description",
        "geogebraId",
        "userId"
      ]
    },
    "ChatMessage": {
      "title": "Chat Message",
      "type": "object",
      "description": "Represents a single message in a chat conversation between a user and the assistant.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user who sent or received the message."
        },
        "role": {
          "type": "string",
          "description": "The author of the message.",
          "enum": [
            "user",
            "assistant"
          ]
        },
        "content": {
          "type": "string",
          "description": "The text content of the message."
        },
        "createdAt": {
          "type": "string",
          "description": "The timestamp when the message was created.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "role",
        "content",
        "createdAt"
      ]
    },
    "UserDocument": {
      "title": "User Document",
      "type": "object",
      "description": "Represents a file uploaded by a user, along with its extracted text content.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user who uploaded the document."
        },
        "fileName": {
          "type": "string",
          "description": "The original name of the uploaded file."
        },
        "storagePath": {
          "type": "string",
          "description": "The path to the file in Firebase Storage."
        },
        "textContent": {
          "type": "string",
          "description": "The extracted text content from the document."
        },
        "createdAt": {
          "type": "string",
          "description": "The timestamp when the document was uploaded.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "fileName",
        "storagePath",
        "textContent",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Accessible only to the user themselves (path-based ownership).",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/messages/{messageId}",
        "definition": {
          "entityName": "ChatMessage",
          "schema": {
            "$ref": "#/backend/entities/ChatMessage"
          },
          "description": "Stores chat messages for a specific user. Accessible only to that user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "messageId",
              "description": "The unique identifier of the chat message."
            }
          ]
        }
      },
      {
        "path": "/geogebraApplets/{geogebraAppletId}",
        "definition": {
          "entityName": "GeogebraApplet",
          "schema": {
            "$ref": "#/backend/entities/GeogebraApplet"
          },
          "description": "Stores Geogebra applets. Includes denormalized 'userId' for authorization independence, allowing direct validation of ownership.",
          "params": [
            {
              "name": "geogebraAppletId",
              "description": "The unique identifier of the Geogebra applet."
            }
          ]
        }
      },
      {
        "path": "/userDocuments/{documentId}",
        "definition": {
          "entityName": "UserDocument",
          "schema": {
            "$ref": "#/backend/entities/UserDocument"
          },
          "description": "Stores metadata and extracted text for user-uploaded files. Accessible only to the owning user.",
          "params": [
            {
              "name": "documentId",
              "description": "The unique identifier of the document record."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the Geometra application, focusing on math assistance and Geogebra applets. It prioritizes authorization independence and follows best practices for security and scalability. User data, Geogebra applets, and assistant interactions are stored in separate collections to maintain a clear and manageable data model.\n\n**Authorization Independence:** The `GeogebraApplet` and `ChatMessage` collections both include the `userId` field, denormalizing the user-applet and user-interaction relationships. This denormalization is crucial for authorization independence. Security rules can directly validate the `userId` against `request.auth.uid` without needing to perform expensive `get()` operations to check user ownership in a parent document. This design allows atomic creation and modification of applets and interactions.\n\n**Structural Segregation:** Data with different access needs is segregated. User profiles are stored under `/users/{userId}`, while applets and interactions are stored in their respective collections, ensuring that security rules can be applied consistently across each collection.\n\n**Access Modeling:** Path-based ownership is used for user data (`/users/{userId}`). `GeogebraApplet` and `ChatMessage` leverage denormalized `userId` fields for ownership checks. This approach simplifies security rules and improves performance.\n\n**QAPs Support:** The design supports secure list operations. The segregation of applets and interactions into separate collections, combined with the denormalized `userId` field, allows listing operations to be secured based on the requesting user's ID. Security rules can ensure that users can only list applets and interactions that they own, without needing to filter based on data content."
  }
}
