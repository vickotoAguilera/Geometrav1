/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for user profiles and chat messages,
 * and a similar ownership model for Geogebra applets, with denormalized userId.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 * - /users/{userId}/messages/{messageId}: Stores chat messages for a specific user, only accessible to that user.
 * - /geogebraApplets/{geogebraAppletId}: Stores Geogebra applets, with denormalized 'userId' for authorization.
 *
 * Key Security Decisions:
 * - User listing is disabled.
 * - All write operations are protected by authorization checks.
 * - Read operations for Geogebra applets are public.
 *
 * Denormalization for Authorization:
 * - GeogebraApplet documents contain a 'userId' field, allowing direct ownership validation without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isSignedIn() && resource != null && request.auth.uid == userId;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for chat messages within a user's profile.
     * @path /users/{userId}/messages/{messageId}
     */
    match /users/{userId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isSignedIn() && resource != null && resource.data.userId == request.auth.uid;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner();
      allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Allows public read access to Geogebra applets, but restricts write access to the owner.
     * @path /geogebraApplets/{geogebraAppletId}
     */
    match /geogebraApplets/{geogebraAppletId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner() {
        return isSignedIn() && resource != null && resource.data.userId == request.auth.uid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner();
      allow delete: if isSignedIn() && isExistingOwner();
    }
  }
}